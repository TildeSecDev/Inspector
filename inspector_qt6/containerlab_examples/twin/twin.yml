name: Denterprise-dt

topology:
  nodes:

    # ===== ISP (Internet simulation) =====
  #  isp:
   #   kind: linux
    #  image: alpine
     # exec:
      #   - ip addr add 203.0.113.1/24 dev eth1
       #  - ip link set eth1 up
        # - ip route add 10.0.0.0/8 via 203.0.113.2 dev eth1
         #- ip route add default via 8.8.8.8

    isp:
       kind: linux
       image: nicolaka/netshoot:latest
       exec:
          - ip addr add 203.0.113.1/24 dev eth1
          - sysctl -w net.ipv4.ip_forward=1
          - iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
          - ip route add 10.0.0.0/8 via 203.0.113.2 dev eth1


    # ===== Firewall (edge security + NAT) =====
    fw:
      kind: rare
      image: ghcr.io/rare-freertr/freertr-containerlab:latest
      env:
        DATAPLANE_TYPE: "pcapInt"
        INIT_VRF: "true"
      binds:
        - ./configs/fw:/config

    # ===== Core Router (internal routing) =====
    core:
      kind: rare
      image: ghcr.io/rare-freertr/freertr-containerlab:latest
      env:
        DATAPLANE_TYPE: "pcapInt"
        INIT_VRF: "true"
      binds:
        - ./configs/core:/config

    # ===== User PCs =====
    pc1:
      kind: linux
      image: alpine
      exec:
        - ip addr add 10.0.10.10/24 dev eth1
        - ip route del
        - ip route add default via 10.0.10.1 dev eth1
        - echo 'nameserver 1.1.1.1' > /etc/resolv.conf
        - echo 'nameserver 8.8.8.8' >> /etc/resolv.conf

        - printf "nameserver 1.1.1.1\nnameserver 8.8.8.8\n" > /etc/resolv.conf
      env:
        IP: 10.0.10.10/24
        GW: 10.0.10.1

    pc2:
      kind: linux
      image: alpine
      exec:
        - ip addr add 10.0.10.11/24 dev eth1
        - ip route del
        - ip route add default via 10.0.10.1 dev eth1
        - printf "nameserver 1.1.1.1\nnameserver 8.8.8.8\n" > /etc/resolv.conf
      env:
        IP: 10.0.10.11/24
        GW: 10.0.10.1

    # ===== Internal Servers =====
    server1:
      kind: linux
      image: alpine
      exec:
        - ip addr add 10.0.20.10/24 dev eth1
        - ip route del
        - ip route add default via 10.0.20.1 dev eth1
        - printf "nameserver 1.1.1.1\nnameserver 8.8.8.8\n" > /etc/resolv.conf
      env:
        IP: 10.0.20.10/24
        GW: 10.0.20.1
      binds:
        - ./data/server1:/data

    server2:
      kind: linux
      image: alpine
      exec:
        - ip addr add 10.0.20.11/24 dev eth1
        - ip route del
        - ip route add default via 10.0.20.1 dev eth1
        - printf "nameserver 1.1.1.1\nnameserver 8.8.8.8\n" > /etc/resolv.conf
      env:
        IP: 10.0.20.11/24
        GW: 10.0.20.1
      binds:
        - ./data/server2:/data

    # ===== Attacker / Pentest =====
    kali:
      kind: linux
      image: kalilinux/kali-rolling  #vxcontrol/kali-linux
      exec:
        - ip addr add 10.0.30.10/24 dev eth1
        - ip link set eth1 up
        - ip route del default via 172.20.20.1 dev eth0 
        - ip route add default via 10.0.30.1 dev eth1
        #- echo -e "nameserver 1.1.1.1\nnameserver 8.8.8.8\n" > /etc/resolv.conf
        - printf "nameserver 1.1.1.1\nnameserver 8.8.8.8\n" > /etc/resolv.conf
        - sysctl -w net.ipv6.conf.all.disable_ipv6=1
        - sysctl -w net.ipv6.conf.default.disable_ipv6=1
      env:
        IP: 10.0.30.10/24
        GW: 10.0.30.1

  links:
    # ISP <-> Firewall (WAN)
    - endpoints: ["isp:eth1", "fw:ethernet1"]

    # Firewall <-> Core (inside)
    - endpoints: ["fw:ethernet2", "core:ethernet1"]

    # Core <-> Users
    - endpoints: ["core:ethernet2", "pc1:eth1"]
    - endpoints: ["core:ethernet3", "pc2:eth1"]

    # Core <-> Servers
    - endpoints: ["core:ethernet4", "server1:eth1"]
    - endpoints: ["core:ethernet5", "server2:eth1"]

    # Core <-> Kali (attacker inside LAN)
    - endpoints: ["core:ethernet6", "kali:eth1"]

