<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Character Animation Test - Mira</title>
  <style>
    html, body {
      width: 100vw; height: 100vh; margin: 0; padding: 0; overflow: hidden; background: #222;
    }
    body {
      display: flex;
      flex-direction: row;
      min-height: 100vh;
      margin: 0;
    }
    #left-sidebar {
      width: 220px;
      background: #f0f0f0;
      padding: 16px;
      box-sizing: border-box;
      border-right: 1px solid #ccc;
      min-height: 100vh;
    }
    #main-content {
      flex: 1;
      padding: 24px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }
    #right-sidebar {
      width: 320px;
      background: #f8f8f8;
      padding: 16px;
      box-sizing: border-box;
      border-left: 1px solid #ccc;
      min-height: 100vh;
    }
    #scene-canvas {
      position: relative;
      width: 100vw;
      height: 80vh;
      background: url('/assets/workshop/backgrounds/bg_cavestory.png') center/cover no-repeat;
      border-bottom: 2px solid #444;
      overflow: hidden;
    }
    /* Checkerboard for sprite contrast */
    #sprite-bg {
      position: absolute;
      width: 96px;
      height: 96px;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background: repeating-linear-gradient(45deg, #eee 0 12px, #ccc 12px 24px);
      opacity: 0.25;
      z-index: 5;
      pointer-events: none;
      display: none;
    }
    .character {
      position: absolute;
      width: 96px;
      height: 96px;
      /* Add a border for visibility */
      border: 1px solid #ffe066;
      background: rgba(0,0,0,0.05);
      transition: left 0.3s cubic-bezier(.4,1.6,.6,1), top 0.3s cubic-bezier(.4,1.6,.6,1), transform 0.2s;
      will-change: left, top, transform;
      z-index: 10;
      pointer-events: none;
      box-sizing: border-box;
    }
    .character img {
      width: 100%; height: 100%;
      image-rendering: pixelated;
      user-select: none;
      pointer-events: none;
      display: block;
    }
    .character.flip {
      transform: scaleX(-1);
    }
    .sprite-label {
      position: absolute;
      left: 0; top: 0;
      width: 100%;
      text-align: left;
      font-size: 1rem;
      color: #222;
      background: rgba(255,255,255,0.7);
      padding: 2px 6px;
      z-index: 20;
      pointer-events: none;
      font-family: 'Kanit', 'Tomorrow', monospace;
      border-bottom-right-radius: 8px;
    }
    #controls {
      padding: 12px;
      background: #181c24;
      color: #fff;
      font-family: 'Kanit', 'Tomorrow', monospace;
      display: flex;
      gap: 18px;
      align-items: center;
    }
    #dialogue, #hint {
      margin: 8px 0 0 0;
      font-size: 1.1rem;
      color: #ffe066;
      min-height: 28px;
      font-family: 'Kanit', 'Tomorrow', monospace;
    }
    #hint { color: #b3e6ff; font-size: 1rem; }
    #timeline {
      margin-top: 10px;
      background: #222;
      color: #fff;
      font-size: 0.95rem;
      padding: 8px;
      border-radius: 6px;
      max-height: 120px;
      overflow-y: auto;
    }
    button, input, select {
      font-family: inherit;
      font-size: 1rem;
      margin-right: 8px;
    }
    #export-btn {
      background: #ffe066;
      color: #222;
      border: none;
      border-radius: 6px;
      padding: 8px 18px;
      cursor: pointer;
      font-weight: bold;
    }
    #export-btn:hover { background: #fff3b0; }
    #show-bbox {
      accent-color: #ffe066;
    }
    #keyframe-editor { background: #23272e; color: #fff; padding: 12px; border-top: 2px solid #444; font-family: 'Kanit', 'Tomorrow', monospace; }
    #keyframe-list { max-height: 120px; overflow-y: auto; margin-bottom: 8px; }
    #keyframe-list .kf-item { padding: 4px 8px; margin: 2px 0; background: #2d323c; cursor: pointer; border-radius: 4px; }
    #keyframe-list .kf-item.selected { background: #ffe066; color: #222; }
    #keyframe-controls button { margin-right: 8px; margin-bottom: 4px; }
    #keyframe-form label { margin-right: 12px; }
  </style>
</head>
<body>
  <div id="left-sidebar">
    <label for="background-select">Background:</label>
    <select id="background-select">
      <option value="bg_castleonthehill.png">bg_castleonthehill.png</option>
      <option value="bg_cavestrory.png">bg_cavestrory.png</option>
      <option value="bg_coffeeshop.png">bg_coffeeshop.png</option>
      <option value="bg_outsidecoffeeshop.png">bg_outsidecoffeeshop.png</option>
      <!-- ...other backgrounds as needed... -->
    </select>
    <label>Sprite:
      <select id="sprite-select">
        <option value="front">Mira Front</option>
        <option value="back">Mira Back</option>
      </select>
    </label>
    <label>Dialogue: <input type="text" id="dialogue-input" placeholder="Enter dialogue..."></label>
    <label>Hint: <input type="text" id="hint-input" placeholder="Enter hint..."></label>
    <button id="cue-dialogue">Cue Dialogue</button>
    <button id="cue-hint">Cue Hint</button>
    <button id="record-keyframe">Record Keyframe</button>
    <button id="export-btn">Export Scene</button>
    <label><input type="checkbox" id="show-bbox"> Show Sprite Box</label>
  </div>
  <div id="main-content">
    <div id="scene-canvas">
      <div id="sprite-bg"></div>
      <div class="character" id="mira" style="left: 50vw; top: 40vh;">
        <span class="sprite-label">Mira</span>
        <img id="mira-img" src="/assets/workshop/avatars/mira/mira_6.png" alt="Mira" onerror="this.style.display='none'">
      </div>
      <div id="dialogue"></div>
      <div id="hint"></div>
    </div>
  </div>
  <div id="right-sidebar">
    <div id="keyframe-editor">
      <h3>Keyframe Editor</h3>
      <button id="add-keyframe-btn">Add Keyframe</button>
      <ul id="keyframe-list"></ul>
      <div id="keyframe-details" style="display:none;">
        <label>Time: <input type="number" id="kf-time"></label>
        <label>Sprite: <input type="text" id="kf-sprite"></label>
        <label>Dialogue: <input type="text" id="kf-dialogue"></label>
        <button id="save-keyframe-btn">Save</button>
        <button id="delete-keyframe-btn">Delete</button>
      </div>
    </div>
  </div>
  <script>
    const mira = document.getElementById('mira');
    const miraImg = document.getElementById('mira-img');
    const dialogueDiv = document.getElementById('dialogue');
    const hintDiv = document.getElementById('hint');
    const timelineDiv = document.getElementById('timeline');
    const bgSelect = document.getElementById('bg-select');
    const spriteSelect = document.getElementById('sprite-select');
    const spriteBg = document.getElementById('sprite-bg');
    const showBbox = document.getElementById('show-bbox');
    let miraState = {
      x: window.innerWidth/2 - 48, y: window.innerHeight*0.4 - 48, facing: 'front', dialogue: '', hint: ''
    };
    let keyframes = [];
    let selectedKeyframe = -1;

    // Sprite map offsets (measured/estimated from mira_6.png)
    // Each sprite: 275x475px, starts at (50,50), 35px horizontal gap, 10px vertical gap between rows
    // Order: [top-left, top-center, top-right, bottom-left, bottom-center, bottom-right]
    const SPRITE_W = 275;
    const SPRITE_H = 475;
    const SPRITE_X0 = 50;
    const SPRITE_Y0 = 50;
    const SPRITE_X_GAP = 35;
    const SPRITE_Y_GAP = 10;
    const miraSpriteOffsets = [
      [SPRITE_X0, SPRITE_Y0], // top-left
      [SPRITE_X0 + (SPRITE_W + SPRITE_X_GAP), SPRITE_Y0], // top-center
      [SPRITE_X0 + 2 * (SPRITE_W + SPRITE_X_GAP), SPRITE_Y0], // top-right
      [SPRITE_X0, SPRITE_Y0 + SPRITE_H + SPRITE_Y_GAP], // bottom-left
      [SPRITE_X0 + (SPRITE_W + SPRITE_X_GAP), SPRITE_Y0 + SPRITE_H + SPRITE_Y_GAP], // bottom-center
      [SPRITE_X0 + 2 * (SPRITE_W + SPRITE_X_GAP), SPRITE_Y0 + SPRITE_H + SPRITE_Y_GAP] // bottom-right
    ];

    // setMiraSprite(frameIdx, facing)
    function setMiraSprite(frameIdx, facing) {
      const [x, y] = miraSpriteOffsets[frameIdx];
      miraImg.style.objectFit = 'none';
      // Set the image size to the full sprite sheet size (or large enough to cover all sprites)
      miraImg.style.width = '900px'; // at least 3 sprites + gaps
      miraImg.style.height = '1020px'; // 2 rows + gap
      miraImg.style.objectPosition = `-${x}px -${y}px`;
      miraImg.style.display = 'block';
      miraImg.src = facing === 'back'
        ? '/assets/workshop/avatars/mira/mira_6_back.png'
        : '/assets/workshop/avatars/mira/mira_6.png';
    }

    // Map facing/action to sprite map index
    function updateMiraSprite() {
      // Default: standing face front hair left (frame 1)
      let frameIdx = 1;
      if (miraState.facing === 'left') {
        frameIdx = 0;
      } else if (miraState.facing === 'right') {
        frameIdx = 2;
      } else if (miraState.facing === 'front') {
        frameIdx = 1;
      } else if (miraState.facing === 'turnedLeft') {
        frameIdx = 3;
      } else if (miraState.facing === 'turnedRight') {
        frameIdx = 5;
      } else if (miraState.facing === 'hairRight') {
        frameIdx = 4;
      }
      setMiraSprite(frameIdx, miraState.facing === 'back' ? 'back' : 'front');
    }

    // Update miraState and sprite on movement
    function updateMira() {
      mira.style.left = miraState.x + 'px';
      mira.style.top = miraState.y + 'px';
      updateMiraSprite();
      dialogueDiv.textContent = miraState.dialogue;
      hintDiv.textContent = miraState.hint;
      // Move checkerboard bg if enabled
      if (showBbox.checked) {
        spriteBg.style.display = 'block';
        spriteBg.style.left = mira.style.left;
        spriteBg.style.top = mira.style.top;
      } else {
        spriteBg.style.display = 'none';
      }
    }
    updateMira();

    // Movement with arrow keys
    document.addEventListener('keydown', e => {
      let moved = false;
      if (e.key === 'ArrowLeft') { miraState.x -= 24; miraState.facing = 'left'; moved = true; }
      if (e.key === 'ArrowRight') { miraState.x += 24; miraState.facing = 'right'; moved = true; }
      if (e.key === 'ArrowUp') { miraState.y -= 24; miraState.facing = 'back'; moved = true; }
      if (e.key === 'ArrowDown') { miraState.y += 24; miraState.facing = 'front'; moved = true; }
      if (moved) {
        updateMira();
        e.preventDefault();
      }
    });

    // Sprite selector
    spriteSelect.addEventListener('change', () => {
      miraState.facing = spriteSelect.value === 'front' ? 'front' : 'back';
      updateMira();
    });

    // Background selector
    bgSelect.addEventListener('change', () => {
      document.getElementById('scene-canvas').style.backgroundImage =
        `url('${bgSelect.value}')`;
    });

    // Cue dialogue/hint
    document.getElementById('cue-dialogue').onclick = () => {
      miraState.dialogue = document.getElementById('dialogue-input').value;
      updateMira();
    };
    document.getElementById('cue-hint').onclick = () => {
      miraState.hint = document.getElementById('hint-input').value;
      updateMira();
    };

    // Record keyframe
    document.getElementById('record-keyframe').onclick = () => {
      const frame = {
        x: miraState.x,
        y: miraState.y,
        facing: miraState.facing,
        dialogue: miraState.dialogue,
        hint: miraState.hint,
        bg: bgSelect.value
      };
      keyframes.push(JSON.parse(JSON.stringify(frame)));
      const idx = keyframes.length - 1;
      const desc = `Keyframe ${idx + 1}: (${frame.x},${frame.y}) ${frame.facing} | "${frame.dialogue}" | "${frame.hint}" | BG: ${frame.bg.split('/').pop()}`;
      const el = document.createElement('div');
      el.textContent = desc;
      timelineDiv.appendChild(el);
    };

    // Export scene as HTML+JS+CSS
    document.getElementById('export-btn').onclick = () => {
      let html = `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Exported Scene</title>
  <style>
    html, body { width: 100vw; height: 100vh; margin: 0; padding: 0; overflow: hidden; background: #222; }
    #scene-canvas { position: relative; width: 100vw; height: 80vh; background: url('${keyframes[0]?.bg || '/assets/workshop/backgrounds/bg_cavestory.png'}') center/cover no-repeat; border-bottom: 2px solid #444; overflow: hidden; }
    .character { position: absolute; width: 96px; height: 96px; transition: left 0.3s, top 0.3s, transform 0.2s; will-change: left, top, transform; z-index: 10; }
    .character img { width: 100%; height: 100%; image-rendering: pixelated; user-select: none; }
    .character.flip { transform: scaleX(-1); }
    #dialogue, #hint { margin: 8px 0 0 0; font-size: 1.1rem; color: #ffe066; min-height: 28px; font-family: 'Kanit', 'Tomorrow', monospace; }
    #hint { color: #b3e6ff; font-size: 1rem; }
    #controls { display: none; }
  </style>
</head>
<body>
  <div id="scene-canvas">
    <div class="character" id="mira" style="left: ${keyframes[0]?.x || 100}px; top: ${keyframes[0]?.y || 300}px;">
      <img id="mira-img" src="${keyframes[0]?.facing === 'back' ? '/assets/workshop/avatars/mira/mira_6_back.png' : '/assets/workshop/avatars/mira/mira_6.png'}" alt="Mira">
    </div>
    <div id="dialogue"></div>
    <div id="hint"></div>
  </div>
  <script>
    const mira = document.getElementById('mira');
    const miraImg = document.getElementById('mira-img');
    const dialogueDiv = document.getElementById('dialogue');
    const hintDiv = document.getElementById('hint');
    const keyframes = ${JSON.stringify(keyframes, null, 2)};
    let idx = 0;
    function showFrame(i) {
      const frame = keyframes[i];
      mira.style.left = frame.x + 'px';
      mira.style.top = frame.y + 'px';
      miraImg.src = frame.facing === 'back'
        ? '/assets/workshop/avatars/mira/mira_6_back.png'
        : '/assets/workshop/avatars/mira/mira_6.png';
      mira.classList.toggle('flip', frame.facing === 'left');
      dialogueDiv.textContent = frame.dialogue;
      hintDiv.textContent = frame.hint;
      document.getElementById('scene-canvas').style.backgroundImage = 'url(' + frame.bg + ')';
    }
    showFrame(0);
    document.body.addEventListener('keydown', e => {
      if (e.key === 'ArrowRight') { if (idx < keyframes.length - 1) showFrame(++idx); }
      if (e.key === 'ArrowLeft') { if (idx > 0) showFrame(--idx); }
    });
  <\/script>
</body>
</html>
      `.trim();
      const blob = new Blob([html], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'index.html';
      a.click();
      setTimeout(() => URL.revokeObjectURL(url), 1000);
    };

    // Show/hide bounding box
    showBbox.addEventListener('change', updateMira);

    // Responsive: recenter on resize
    window.addEventListener('resize', () => {
      miraState.x = window.innerWidth/2 - 48;
      miraState.y = window.innerHeight*0.4 - 48;
      updateMira();
    });

    function renderKeyframeList() {
      const list = document.getElementById('keyframe-list');
      list.innerHTML = '';
      keyframes.forEach((kf, i) => {
        const div = document.createElement('div');
        div.className = 'kf-item' + (i === selectedKeyframe ? ' selected' : '');
        div.textContent = `#${i+1}: (${kf.x},${kf.y}) ${kf.facing} | "${kf.dialogue}"`;
        div.onclick = () => selectKeyframe(i);
        list.appendChild(div);
      });
    }
    function selectKeyframe(i) {
      selectedKeyframe = i;
      const kf = keyframes[i];
      document.getElementById('kf-x').value = kf.x;
      document.getElementById('kf-y').value = kf.y;
      document.getElementById('kf-facing').value = kf.facing;
      document.getElementById('kf-dialogue').value = kf.dialogue;
      document.getElementById('kf-hint').value = kf.hint;
      renderKeyframeList();
      // Preview selected keyframe
      miraState.x = kf.x;
      miraState.y = kf.y;
      miraState.facing = kf.facing;
      miraState.dialogue = kf.dialogue;
      miraState.hint = kf.hint;
      updateMira();
    }
    document.getElementById('add-keyframe').onclick = () => {
      const kf = {
        x: parseInt(document.getElementById('kf-x').value) || miraState.x,
        y: parseInt(document.getElementById('kf-y').value) || miraState.y,
        facing: document.getElementById('kf-facing').value,
        dialogue: document.getElementById('kf-dialogue').value,
        hint: document.getElementById('kf-hint').value
      };
      keyframes.push(kf);
      selectedKeyframe = keyframes.length - 1;
      renderKeyframeList();
    };
    document.getElementById('delete-keyframe').onclick = () => {
      if (selectedKeyframe >= 0) {
        keyframes.splice(selectedKeyframe, 1);
        selectedKeyframe = -1;
        renderKeyframeList();
      }
    };
    document.getElementById('move-up-keyframe').onclick = () => {
      if (selectedKeyframe > 0) {
        [keyframes[selectedKeyframe-1], keyframes[selectedKeyframe]] = [keyframes[selectedKeyframe], keyframes[selectedKeyframe-1]];
        selectedKeyframe--;
        renderKeyframeList();
      }
    };
    document.getElementById('move-down-keyframe').onclick = () => {
      if (selectedKeyframe >= 0 && selectedKeyframe < keyframes.length-1) {
        [keyframes[selectedKeyframe+1], keyframes[selectedKeyframe]] = [keyframes[selectedKeyframe], keyframes[selectedKeyframe+1]];
        selectedKeyframe++;
        renderKeyframeList();
      }
    };
    document.getElementById('update-keyframe').onclick = () => {
      if (selectedKeyframe >= 0) {
        const kf = keyframes[selectedKeyframe];
        kf.x = parseInt(document.getElementById('kf-x').value) || miraState.x;
        kf.y = parseInt(document.getElementById('kf-y').value) || miraState.y;
        kf.facing = document.getElementById('kf-facing').value;
        kf.dialogue = document.getElementById('kf-dialogue').value;
        kf.hint = document.getElementById('kf-hint').value;
        renderKeyframeList();
      }
    };
    // Initialize form with current mira state
    document.getElementById('kf-x').value = miraState.x;
    document.getElementById('kf-y').value = miraState.y;
    document.getElementById('kf-facing').value = miraState.facing;
    document.getElementById('kf-dialogue').value = '';
    document.getElementById('kf-hint').value = '';
    renderKeyframeList();
  </script>
</body>
</html>
