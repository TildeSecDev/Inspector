<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mira – Coffee Shop (Object Scenes)</title>
  <style>
    body { margin:0; background:#1a1716; overflow:hidden; }
    canvas { display:block; image-rendering: pixelated; }
    body { margin:0; background:#1a1716; overflow:hidden; }
    canvas { display:block; image-rendering: auto; -webkit-font-smoothing:antialiased; image-rendering: optimizeQuality; }

    .hud {
      position:absolute; top:10px; left:10px;
      font-family: monospace; font-size:14px;
      background:rgba(0,0,0,.6); color:#f6e5c8;
      padding:6px 10px; border-radius:6px;
      z-index:30;
    }

    /* First-person mira sprite overlay (use a sprite image inserted via JS or an <img> with class "mira-sprite") */
    .mira-sprite {
      position: absolute;
      left: 50%;
      bottom: 10%;
      transform: translateX(-50%);
      width: 160px;               /* adjust size as needed */
      height: auto;
      pointer-events: none;
      z-index: 20;
      image-rendering: auto;      /* reduce blocky pixelation */
      filter: drop-shadow(0 10px 18px rgba(0,0,0,0.7)) saturate(1.05);
      opacity: 0.98;
      will-change: transform;
      transition: transform 120ms linear;
      mix-blend-mode: normal;
      user-select: none;
      -webkit-user-drag: none;
      backface-visibility: hidden;
      transform-origin: 50% 100%;
      /* gentle bob to feel "alive" in first-person */
      animation: mira-bob 1.2s ease-in-out infinite;
    }

    @keyframes mira-bob {
      0%   { transform: translateX(-50%) translateY(0) scale(1); }
      50%  { transform: translateX(-50%) translateY(-6px) scale(1.01); }
      100% { transform: translateX(-50%) translateY(0) scale(1); }
    }

    /* Helper classes if JS toggles first-person mode */
    .fp-hide-mesh canvas { opacity: 1; } /* placeholder if you want to fade canvas instead of showing cube */
    .fp-overlay { cursor: none; }        /* hide cursor in first-person */
  </style>
</head>
<body>
<div class="hud">Mira – Coffee Shop | Use Arrows / WASD to move</div>
<script type="module">
import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';

// ====== Core setup ======
const scene = new THREE.Scene();
const camera = new THREE.OrthographicCamera(-15,15,10,-10,0.1,100);
camera.position.set(0,15,15);
camera.lookAt(0,0,0);

const renderer = new THREE.WebGLRenderer({antialias:false});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

window.addEventListener('resize',()=>{
  const aspect = window.innerWidth / window.innerHeight;
  camera.left = -15*aspect; camera.right = 15*aspect;
  camera.top = 10; camera.bottom = -10;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});

// ====== Helper factories ======
function makeTable(x,z){
  const t = new THREE.Mesh(
    new THREE.CylinderGeometry(1.2,1.2,0.4,16),
    new THREE.MeshBasicMaterial({color:0x5c3317})
  );
  t.position.set(x,0.2,z);
  scene.add(t);
  return t;
}
function makeChair(x,y,z){
  const c = new THREE.Mesh(
    new THREE.BoxGeometry(0.8,1,0.8),
    new THREE.MeshBasicMaterial({color:0x3b2415})
  );
  c.position.set(x,y,z);
  scene.add(c);
  return c;
}
function makePlant(x,z){
  const pot = new THREE.Mesh(
    new THREE.CylinderGeometry(0.6,0.8,0.6,8),
    new THREE.MeshBasicMaterial({color:0x442311})
  );
  pot.position.set(x,0.3,z);
  scene.add(pot);
  const leaves = new THREE.Mesh(
    new THREE.ConeGeometry(0.8,1.5,8),
    new THREE.MeshBasicMaterial({color:0x2f7a2f})
  );
  leaves.position.set(x,1.3,z);
  scene.add(leaves);
}
function makeTextPlane(text,color,bg,w,h){
  const c=document.createElement('canvas');c.width=256;c.height=64;
  const g=c.getContext('2d');
  g.fillStyle=bg; g.fillRect(0,0,c.width,c.height);
  g.fillStyle=color; g.font='bold 36px monospace';
  g.textAlign='center'; g.textBaseline='middle';
  g.fillText(text,c.width/2,c.height/2);
  const tex=new THREE.CanvasTexture(c);
  tex.minFilter=THREE.NearestFilter; tex.magFilter=THREE.NearestFilter;
  return new THREE.Mesh(new THREE.PlaneGeometry(w,h),
    new THREE.MeshBasicMaterial({map:tex,transparent:true}));
}

// ====== Interior scene ======
const interior = new THREE.Group();
{
  const floor = new THREE.Mesh(new THREE.PlaneGeometry(20,20),
    new THREE.MeshBasicMaterial({color:0x6a4028}));
  floor.rotation.x=-Math.PI/2;
  interior.add(floor);

  const wall = new THREE.Mesh(new THREE.PlaneGeometry(20,8),
    new THREE.MeshBasicMaterial({color:0x8b4c39}));
  wall.position.set(0,4,-10);
  interior.add(wall);

  const counter = new THREE.Mesh(new THREE.BoxGeometry(12,2,2),
    new THREE.MeshBasicMaterial({color:0x4b2e1a}));
  counter.position.set(0,1,-9.9);
  interior.add(counter);

  interior.add(makeTable(-4,0));
  interior.add(makeTable(4,0));
  interior.add(makeTable(-4,-4));
  interior.add(makeTable(4,-4));

  makePlant(-8,-8); makePlant(8,-8);
}
scene.add(interior);

// ====== Exterior scene ======
const exterior = new THREE.Group();
{
  const ground = new THREE.Mesh(new THREE.PlaneGeometry(30,10),
    new THREE.MeshBasicMaterial({color:0x444444}));
  ground.rotation.x=-Math.PI/2;
  exterior.add(ground);

  const wall = new THREE.Mesh(new THREE.PlaneGeometry(20,12),
    new THREE.MeshBasicMaterial({color:0x8b4c39}));
  wall.position.set(0,6,-5);
  exterior.add(wall);

  // Awning
  for(let i=-5;i<=5;i++){
    const stripe = new THREE.Mesh(
      new THREE.BoxGeometry(1,0.5,2),
      new THREE.MeshBasicMaterial({color:(i%2?0xaa3333:0xffffff)})
    );
    stripe.position.set(i,11,-4.9);
    exterior.add(stripe);
  }

  // Coffee sign
  const sign = makeTextPlane("COFFEE","#f6e5c8","#333",12,2);
  sign.position.set(0,9,-4.8);
  exterior.add(sign);

  // Outside tables
  const t1 = makeTable(-4,2); const t2 = makeTable(4,2);
  exterior.add(t1); exterior.add(t2);
}
exterior.visible=false;
scene.add(exterior);

// ====== Mira (player cube placeholder) ======
const mira = new THREE.Mesh(
  new THREE.BoxGeometry(0.8,1.2,0.8),
  new THREE.MeshBasicMaterial({color:0xf2d7b3})
);
mira.position.set(0,0.6,6);
scene.add(mira);

// ====== Controls ======
const keys=new Set();
document.addEventListener('keydown',e=>keys.add(e.code));
document.addEventListener('keyup',e=>keys.delete(e.code));

// ====== Scene switching ======
let mode='interior';
function toggleScene(){
  if(mode==='interior'){
    interior.visible=false; exterior.visible=true;
    mira.position.set(0,0.6,4);
    mode='exterior';
  } else {
    interior.visible=true; exterior.visible=false;
    mira.position.set(0,0.6,6);
    mode='interior';
  }
}

// ====== Animate loop ======
const clock=new THREE.Clock();
function animate(){
  requestAnimationFrame(animate);
  const dt=clock.getDelta();
  let dx=0,dz=0;
  if(keys.has('ArrowUp')||keys.has('KeyW')) dz-=1;
  if(keys.has('ArrowDown')||keys.has('KeyS')) dz+=1;
  if(keys.has('ArrowLeft')||keys.has('KeyA')) dx-=1;
  if(keys.has('ArrowRight')||keys.has('KeyD')) dx+=1;
  const speed=5;
  mira.position.x+=dx*speed*dt;
  mira.position.z+=dz*speed*dt;

  // Door detection (approx center front)
  if(mode==='interior' && mira.position.z<-8){
    toggleScene();
  }
  if(mode==='exterior' && mira.position.z<-4){
    toggleScene();
  }

  renderer.render(scene,camera);
}
animate();
</script>
</body>
</html>