<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="/css/rtl.css">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Inspector is a gamified, block-based editor for learning hacking and core cybersecurity concepts.">
  <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:; script-src * 'unsafe-inline' 'unsafe-eval' data: blob:; style-src * 'unsafe-inline' data: blob:; img-src * data: blob:; connect-src * data: blob:;">

  <title data-i18n="app.title">Inspector - TildeSec</title>
  <link rel="icon" href="/assets/images/TildeSec.png" type="image/png">

  <!-- CSS Stylesheets -->
  <link rel="stylesheet" href="/css/general.css">
  <link rel="stylesheet" href="/css/header.css">
  <link rel="stylesheet" href="/css/sidebar.css">
  <link rel="stylesheet" href="/css/blocks.css">
  <link rel="stylesheet" href="/css/workspace.css">
  <link rel="stylesheet" href="/css/new-layout.css">
  <link rel="stylesheet" href="/css/infopanel.css">
  <link rel="stylesheet" href="/css/achievements.css">
  <link rel="stylesheet" href="/css/profile.css">
  <link rel="stylesheet" href="/css/leaderboard.css">
  <link rel="stylesheet" href="/css/search.css">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tomorrow:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900&family=Tomorrow:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300..700&display=swap" rel="stylesheet">

  <!-- JS Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- Include xterm.js CSS with rxvt-unicode-256color theme -->
  <link rel="stylesheet" href="https://unpkg.com/xterm/css/xterm.css" />
  <style>
    /* Custom rxvt-unicode-256color styling */
    .xterm {
      font-family: Liberation Mono, Consolas, monospace !important;
      font-weight: normal !important;
      background-color: #2e3440 !important;
      color: #d8dee9 !important;
      border: 1px solid #4c566a;
      border-radius: 0 !important; /* rxvt has square corners */
    }
    
    .xterm-viewport {
      background-color: #2e3440 !important;
    }
    
    .xterm-cursor-layer {
      background-color: #d8dee9 !important;
    }
    
    .xterm-selection-layer {
      background-color: #434c5e !important;
    }
    
    /* Disable text smoothing for more authentic terminal look */
    .xterm-screen {
      -webkit-font-smoothing: none;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeSpeed;
    }
  </style>

  <script type="module" src="/js/preload.js" defer></script>
  <script type="module" src="/js/sidebar.js" defer></script>
  <script type="module" src="/js/navbuttons.js" defer></script>
  <script type="module" src="/js/blocks.js" defer></script>
  <script src="/js/achievements.js" defer></script>
  <script type="module" src="/js/profile.js" defer></script>
  <script type="module" src="/js/leaderboard.js" defer></script>
  <script type="module" src="/js/search.js" defer></script>
  <script src="/js/onboarding.js" defer></script>
  <script src="/js/layout-controls.js" defer></script>
  <script src="/js/canvas-tabs.js" defer></script>
  <script src="/js/i18n.js" defer></script>

  <style>
    #workshop-container, #workshop-container > * {
      width: 100% !important;
      height: 100% !important;
      min-width: 0;
      min-height: 0;
      box-sizing: border-box;
      overflow: hidden;
      position: relative;
    }
  </style>
</head>

<body data-page="index">
  <script>
  // Set lesson_id cookie for RPG validation before any JS loads
  if (!document.cookie.includes('lesson_id=rpg')) {
    document.cookie = 'lesson_id=rpg; path=/';
  }
  </script>

  <div class="screen-size-warning">
    <img src="/assets/images/TildeSec.png">
    <div class="msg">
  <h1 data-i18n="screen.tooSmall.title">:(</h1>
  <p data-i18n="screen.tooSmall.msg">TIGHT SQUEEZE! Please adjust your screen size and try again.</p>
    </div>
  </div>

  <div id="loading-screen" class="loading-screen">
  <img src="/assets/images/TildeSec.png" alt="TildeSec Logo" data-i18n="loading.logoAlt">
  </div>

  <div id="about-modal" class="about-container about-hidden">
    <div class="about-content">
  <h1 data-i18n="about.title">About</h1>
      <span class="abt-divider"></span>
      <div class="abt-info">
  <p data-i18n="about.version">Inspector Version 0.0.1</p>
        <span class="text-space"></span>
  <p data-i18n="about.createdBy">Created By the Cyber Education, Research and Resilience Foundation Team</p>
  <p data-i18n="about.developedBy">Developed by Nathan, Wadoud, and TildeSec</p>
        <span class="text-space"></span>
  <p data-i18n="about.description">Inspector is for learning hacking and cybersecurity using Bash.</p>
      </div>
      <span class="abt-divider"></span>
  <button id="abt-close-btn" class="abt-close" data-i18n="about.close">Close</button>
    </div>
  </div>

  <div id="settings-modal" class="settings-modal settings-hidden">
    <div class="settings-content">
  <h2 data-i18n="settings.title">Settings</h2>
      <div class="settings-section">
  <label for="theme-switch" data-i18n="settings.theme">Theme:</label>
        <select id="theme-switch">
          <option value="dark" data-i18n="settings.theme.dark">Dark</option>
          <option value="light" data-i18n="settings.theme.light">Light</option>
        </select>
      </div>
      <div class="settings-section">
  <label for="username-input" data-i18n="settings.username">Change Username:</label>
  <input type="text" id="username-input" name="username" placeholder="Enter new username" data-i18n="settings.username.placeholder">
  <button id="save-username-btn" data-i18n="settings.username.save">Save</button>
      </div>
      <div class="settings-section">
  <button id="reset-story-btn" data-i18n="settings.progress.resetStory">Reset Story Progress</button>
  <button id="reset-task-btn" data-i18n="settings.progress.resetTask">Reset Task Progress</button>
      </div>
      <div class="settings-section">
  <label for="email-input" data-i18n="settings.email">Change Email:</label>
  <input type="email" id="email-input" name="email" placeholder="Enter new email" data-i18n="settings.email.placeholder">
  <button id="save-email-btn" data-i18n="settings.email.save">Save</button>
      </div>
      <div class="settings-section">
  <label for="terminal-design-select" data-i18n="settings.terminalDesign">Terminal Design:</label>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
          <label style="font-size:0.95em;" for="terminal-bg-color" data-i18n="settings.terminal.background">Background <input type="color" id="terminal-bg-color" name="terminal-bg-color" value="#1d1f21" style="vertical-align:middle;"></label>
          <label style="font-size:0.95em;" for="terminal-text-color" data-i18n="settings.terminal.text">Text <input type="color" id="terminal-text-color" name="terminal-text-color" value="#c5c8c6" style="vertical-align:middle;"></label>
          <label style="font-size:0.95em;" for="terminal-font-style" data-i18n="settings.terminal.font">Font
            <select id="terminal-font-style" name="terminal-font-style">
              <option value="Fira Code, monospace">Fira Code</option>
              <option value="Source Code Pro, monospace">Source Code Pro</option>
              <option value="monospace">Monospace</option>
              <option value="Kanit, sans-serif">Kanit</option>
              <option value="Tomorrow, sans-serif">Tomorrow</option>
            </select>
          </label>
          <button id="apply-terminal-style-btn" style="margin-left:10px;" data-i18n="settings.terminal.apply">Apply</button>
        </div>
      </div>
  <button id="close-settings-btn" class="settings-close" data-i18n="settings.close">Close</button>
    </div>
  </div>

  <div class="profile-popup" id="profile-popup">
    <div class="profile-popup-content">
      <button class="profile-popup-close" id="profile-popup-close">&times;</button>
      <div class="profile-header">
        <img id="profile-picture" src="/assets/images/default_profile.svg" alt="Profile Picture" data-i18n="profile.pictureAlt" style="cursor:pointer;">
        <input type="file" id="profile-picture-input" accept="image/*" style="display:none;" />
        <div class="profile-info">
          <div class="profile-username" id="profile-username"></div>
          <div class="profile-email" id="profile-email"></div>
          <div class="profile-leaderboard"><span data-i18n="profile.leaderboardPosition">Leaderboard Position:</span> <span id="profile-leaderboard"></span></div>
          <div class="profile-friends"><span data-i18n="profile.friends">Friends:</span> <span id="profile-friends"></span></div>
          <div id="profile-friend-list" class="profile-friend-list"></div>
        </div>
      </div>
      <div class="profile-stats">
        <div><b data-i18n="profile.timeOverall">Time Spent Overall:</b> <span id="profile-time-overall"></span></div>
        <div><b data-i18n="profile.timeBreakdown">Time Per Task/Topic/Activity/Sandbox:</b>
          <ul id="profile-time-breakdown"></ul>
        </div>
        <div><b data-i18n="profile.activitiesStarted">Activities Started:</b> <span id="profile-activities-started"></span></div>
        <div><b data-i18n="profile.activitiesCompleted">Activities Completed:</b> <span id="profile-activities-completed"></span></div>
        <div><b data-i18n="profile.commandsRan">Commands Ran:</b> <span id="profile-commands"></span></div>
        <div><b data-i18n="profile.lastLogin">Last login:</b> <span id="profile-login"></span></div>
        <div style="display:flex;justify-content:center;margin-top:18px;">
          <button id="profile-logout" style="background:#ffe066;color:#232946;border:none;border-radius:6px;padding:10px 32px;font-size:1.1em;font-weight:bold;cursor:pointer;" data-i18n="profile.logout">Logout</button>
        </div>
      </div>
    </div>
  </div>

  <header class="main-nav" style="display:flex;align-items:center;justify-content:space-between;gap:16px;padding:4px 12px;">
    <div class="logo-container" style="display:flex;align-items:center;gap:10px;flex:1;min-width:0;">
      <img src="/assets/images/TildeSec.png" alt="TildeSec Logo" style="height:42px;width:auto;object-fit:contain;display:block;">
      <h1 class="title" style="font-family: 'Tomorrow', sans-serif;font-size:24px;margin:0;flex:1;text-align:center;">TildeSec</h1>
      <span class="client-id" style="flex:1;text-align:center;font-weight:600;">{{username}}</span>
    </div>

    <div class="button-container" style="display:flex;align-items:center;gap:4px;">
      <button id="notification-btn">
        <img src="/assets/images/notification.svg" alt="Notification Button" data-i18n="header.notificationAlt">
      </button>
      <button id="trophy-btn">
        <img src="/assets/images/trophy.svg" alt="Trophy Button" data-i18n="header.trophyAlt">
      </button>
      <button id="nav-btn-about">
        <img src="/assets/images/help.svg" alt="Help Button" data-i18n="header.helpAlt">
      </button>
      <button>
        <img src="/assets/images/settings.svg" alt="Settings Button" data-i18n="header.settingsAlt">
      </button>
      <button id="leaderboard-btn"><img src="/assets/images/leaderboard.svg" alt="Leaderboard" data-i18n="header.leaderboardAlt"></button>
      <button id="search-btn"><img src="/assets/images/search.svg" alt="Search" data-i18n="header.searchAlt"></button>
      <select id="language-select" style="margin-left:8px;">
        <option value="english">EN</option>
        <option value="spanish">ES</option>
        <option value="german">DE</option>
        <option value="french">FR</option>
        <option value="arabic">AR</option>
      </select>
      <!-- Default Terminal OS selector (persistent) -->
      <select id="default-terminal-os" title="Default Terminal OS" style="margin-left:6px;">
        <option value="">OS: auto</option>
        <option value="kali">Kali</option>
        <option value="windows">Windows</option>
        <option value="osx" data-requires-macos>macOS</option>
      </select>
    </div>
  </header>

  <main>
    <!-- Main Content Area with Workspace and Workshop Panel -->
    <div class="main-content">
      <!-- Workspace Section (Block Editor/Network Editor) -->
      <div class="workspace">
        <div class="workspace-header">
          <div class="canvas-tabs">
            <button class="canvas-tab active" data-tab="block-editor" data-i18n="workspace.blockEditor">Block Editor</button>
            <button class="canvas-tab" data-tab="network-editor" data-i18n="workspace.networkEditor">Network Editor</button>
          </div>
          <div class="workspace-tools" style="display:flex;align-items:center;gap:6px;margin-left:auto;padding-right:8px;">
            <button id="btn-export-setup" title="Export current setup" data-i18n-title="tooltips.exportSetup" style="font-size:11px;padding:4px 8px;" data-i18n="buttons.export">Export</button>
            <button id="btn-import-setup" title="Import a saved setup" data-i18n-title="tooltips.importSetup" style="font-size:11px;padding:4px 8px;" data-i18n="buttons.import">Import</button>
            <input type="file" id="import-file-input" accept="application/json" style="display:none;" />
          </div>
          <button class="workspace-collapse-btn" id="workspace-collapse-btn" title="Collapse Workspace" data-i18n-title="tooltips.collapseWorkspace">
            <span>&#x2212;</span>
          </button>
        </div>
        <!-- Separate drop areas for each editor -->
        <div class="canvas-container">
          <div class="canvas block-editor-canvas active" id="drop-area">
            <!-- Block Editor drop area - this is the main drop area -->
          </div>
          <div class="canvas network-editor-canvas" id="network-drop-area">
            <!-- Network Editor drop area -->
            <svg id="network-connections-layer" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;overflow:visible;"></svg>
            <div id="network-toolbar" style="position:absolute;top:6px;right:6px;display:flex;gap:6px;z-index:10;">
              <button id="btn-start-link" style="font-size:11px;padding:4px 8px;" data-i18n="buttons.linkDevices">Link Devices</button>
              <button id="btn-cancel-link" style="font-size:11px;padding:4px 8px;display:none;" data-i18n="buttons.cancelLink">Cancel Link</button>
            </div>
          </div>
        </div>
        <button id="run-button" class="run-button">
          <img src="/assets/images/play.svg" alt="Run Button" data-i18n="buttons.runAlt">
        </button>
      </div>
      
      <div class="workshop-resizer" id="workshop-resizer"></div>
      <div class="workshop-panel" id="workshop-panel">
        <div class="info-panel">
          <div id="workshop-container" style="height:100%;"></div>
        </div>
      </div>
    </div>

    <!-- Bottom Panel with Sidebar and Terminal -->
    <div class="bottom-panel">
      <!-- Sidebar Section (moved from top) -->
      <div class="sidebar" id="sidebar">
        <!-- Sidebar toggle button at the top of the sidebar -->
  <button id="sidebar-toggle-btn" title="Toggle Sidebar" data-i18n-title="tooltips.toggleSidebar">☰</button>
        
        <div class="categories-container">
          <!-- Terminal button -->
          <div class="category-btn" data-category="terminal" data-i18n="categories.terminal">Terminal</div>
          
          <div class="category-btn" data-category="general" data-i18n="categories.general">General</div>
          <div class="category-btn" data-category="network" data-i18n="categories.network">Network</div>
          <div class="category-btn" data-category="devices" data-i18n="categories.devices">Devices</div>
          <div class="category-btn" data-category="database" data-i18n="categories.database">Database</div>
          <div class="category-btn" data-category="files" data-i18n="categories.files">Files</div>
          <div class="category-btn" data-category="system" data-i18n="categories.system">System</div>
          <div class="category-btn" data-category="misc" data-i18n="categories.misc">Misc</div>
          <div class="category-btn" data-category="tools" data-i18n="categories.tools">Tools</div>
          <div class="category-btn" data-category="apps" data-i18n="categories.apps">Apps</div>
          <div class="category-btn" data-category="server" data-i18n="categories.server">Server</div>
          <div class="category-btn" data-category="analysis" data-i18n="categories.analysis">Analysis</div>
        </div>
      </div> <!-- End sidebar -->
      
      <!-- Blocks display area - shows draggable blocks when category is selected -->
      <div class="blocks-display-area" style="display: none;">
        <div class="block-list active-block-list"></div>
      </div>
      
      <!-- Terminal/Console Section (moved inside bottom-panel) -->
      <div class="console">
        <div class="console-header" style="position:relative;display:flex;align-items:center;flex-direction:row;padding:0 8px 0 0;min-height:36px;">
          <!-- New terminal button group -->
          <div class="terminal-btn-group" style="display:inline-flex;align-items:center;gap:0;">
            <div id="terminal-tabs" style="display:inline-flex;align-items:center;"></div>
            <button id="btn-new-terminal" style="background:transparent;border:none;color:#6a7df9;border-radius:3px;padding:2px 10px;font-size:16px;line-height:1.2;display:flex;align-items:center;gap:4px;cursor:pointer;transition:background 0.2s;">
              <span style="font-size:20px;line-height:1;">+</span>
            </button>
            <button id="btn-terminal-dropdown" style="background:transparent;border:none;color:#6a7df9;border-radius:3px;padding:2px 6px;font-size:13px;line-height:1.2;display:flex;align-items:center;cursor:pointer;position:relative;">
              <span style="font-size:15px;">&#9660;</span>
            </button>
          </div>
          <span style="flex:1;text-align:center;letter-spacing:2px;color:#888;font-family:'Fira Code',monospace;font-size:12px;white-space:nowrap;" data-i18n="console.title">TildeSec CONSOLE</span>
          <button class="console-collapse-btn" id="console-collapse-btn" title="Collapse Console" data-i18n-title="tooltips.collapseConsole" style="margin-right:8px;background:transparent;border:none;color:#6a7df9;border-radius:3px;padding:2px 8px;font-size:12px;cursor:pointer;">
            <span style="font-size:16px;">&#x2212;</span>
          </button>
          <button id="btn-console-minimize" style="position:relative;margin-left:0;background:transparent;border:none;color:#6a7df9;border-radius:3px;padding:2px 10px;font-size:12px;line-height:1.2;display:flex;align-items:center;gap:4px;cursor:pointer;transition:background 0.2s;">
            <span style="font-size:16px;line-height:1;">&#x2212;</span>
            <span style="font-size:11px;letter-spacing:0.5px;" data-i18n="terminal.hide">hide</span>
          </button>
          <!-- Move dropdown menu here so it overlays the terminal -->
          <div id="terminal-dropdown-menu" style="display:none;position:absolute;top:36px;left:0;z-index:9999;background:#23272e;color:#c5c8c6;border-radius:4px;box-shadow:0 2px 8px #0004;padding:4px 0;min-width:180px;pointer-events:auto;">
            <div class="dropdown-item" data-action="delete" style="padding:6px 16px;cursor:pointer;" data-i18n="terminal.delete">Delete Terminal</div>
            <div class="dropdown-item" data-action="end-process" style="padding:6px 16px;cursor:pointer;" data-i18n="terminal.endProcess">End Running Process</div>
            <div class="dropdown-divider" style="height:1px;background:#333;margin:4px 0;"></div>
            <div class="dropdown-item" data-action="shell-root" style="padding:6px 16px;cursor:pointer;" data-i18n="terminal.shell.root">Switch to Root Shell</div>
            <div class="dropdown-item" data-action="shell-bash" style="padding:6px 16px;cursor:pointer;" data-i18n="terminal.shell.bash">Switch to Bash</div>
            <div class="dropdown-item" data-action="shell-zsh" style="padding:6px 16px;cursor:pointer;" data-i18n="terminal.shell.zsh">Switch to Zsh</div>
            <div class="dropdown-item" data-action="shell-batch" style="padding:6px 16px;cursor:pointer;" data-i18n="terminal.shell.batch">Switch to Batch</div>
            <div class="dropdown-item" data-action="shell-pwsh" style="padding:6px 16px;cursor:pointer;" data-i18n="terminal.shell.pwsh">Switch to PowerShell</div>
          </div>
        </div>
        <div id="output-terminal" class="terminal"></div>
        <div class="console-footer"></div>
      </div>
  <button id="peek-terminal-btn" style="display:none;position:absolute;bottom:0;left:50%;transform:translateX(-50%);z-index:1002;background:#ffe066;border:none;border-radius:6px 6px 0 0;padding:6px 18px;font-size:1.1rem;cursor:pointer;box-shadow:2px 2px 8px #0002;" data-i18n="buttons.showTerminal">Show Terminal</button>
    </div> <!-- End bottom-panel -->
  </main>

  <script>
  // Persist and initialize Default Terminal OS selector
  (function(){
    const sel = document.getElementById('default-terminal-os');
    if (!sel) return;
    // Gate macOS option when feature disabled
    try {
      if (!window.FEATURE_MACOS_DOCKUR || window.FEATURE_MACOS_DOCKUR !== '1') {
        const opt = sel.querySelector('option[value="osx"]');
        if (opt) opt.remove();
      }
    } catch {}
    const saved = localStorage.getItem('defaultTerminalOS') || '';
    if (saved) sel.value = saved;
    sel.addEventListener('change', () => {
      if (sel.value) {
        localStorage.setItem('defaultTerminalOS', sel.value);
      } else {
        localStorage.removeItem('defaultTerminalOS');
      }
      // Notify running terminal script to send preference on next socket open
      window.dispatchEvent(new CustomEvent('terminal-os-updated', { detail: { os: sel.value }}));
    });
  })();

  // Inject option into existing settings-content panel if present
  window.addEventListener('DOMContentLoaded', () => {
    const sc = document.querySelector('.settings-content');
    if (sc && !sc.querySelector('.settings-terminal-os')) {
      const wrapper = document.createElement('div');
      wrapper.className = 'settings-terminal-os';
      wrapper.style.marginTop = '12px';
      wrapper.innerHTML = `<label style="display:block;font-weight:600;margin-bottom:4px;">Default Terminal OS</label>
        <select id="settings-default-terminal-os" style="width:100%;padding:4px 6px;">
          <option value="">Auto</option>
          <option value="kali">Kali</option>
          <option value="windows">Windows</option>
          <option value="osx">macOS</option>
        </select>`;
      sc.appendChild(wrapper);
      const mainSel = document.getElementById('default-terminal-os');
      const settingsSel = document.getElementById('settings-default-terminal-os');
      if (mainSel && settingsSel) {
        settingsSel.value = mainSel.value;
        settingsSel.addEventListener('change', () => { mainSel.value = settingsSel.value; mainSel.dispatchEvent(new Event('change')); });
        mainSel.addEventListener('change', () => { settingsSel.value = mainSel.value; });
      }
    }
  });
  </script>

  <!-- Include xterm.js and its addon from CDN -->
  <script src="https://unpkg.com/xterm/lib/xterm.js"></script>
  <script src="https://unpkg.com/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
  <script src="/js/xterm.js"></script>
  <script>
    // Only RPG workshop loader remains here
    document.addEventListener('DOMContentLoaded', async () => {
      const container = document.getElementById('workshop-container');
      window.currentWorkshopActivity = 'rpg';

      // Ensure global bottom-right RPG debug overlay exists before workshop HTML/JS runs
      function ensureRPGDebugOverlay() {
        if (!document.getElementById('rpg-debug-overlay-styles')) {
          const style = document.createElement('style');
          style.id = 'rpg-debug-overlay-styles';
          style.textContent = `
            .rpg-debug-overlay{position:fixed;right:16px;bottom:16px;z-index:99999;display:flex;align-items:center;justify-content:center;width:56px;height:56px;border-radius:50%;background:#222;color:#ffe066;box-shadow:0 8px 24px rgba(0,0,0,.25);transition:width .2s ease,height .2s ease,border-radius .2s ease,background .2s ease;overflow:hidden}
            .rpg-debug-overlay .rpg-debug-toggle{border:none;background:transparent;color:inherit;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-weight:600;font-size:14px;cursor:pointer}
            .rpg-debug-overlay .rpg-debug-panel{display:none;width:100%;height:100%;flex-direction:column;gap:6px;padding:10px;box-sizing:border-box}
            .rpg-debug-overlay.open{width:340px;height:260px;border-radius:16px;background:#1b1b1b}
            .rpg-debug-overlay.open .rpg-debug-toggle{display:none}
            .rpg-debug-overlay.open .rpg-debug-panel{display:flex}
            #rpg-debug-banner{background:#ffecb3;color:#333;border:1px solid #fbc02d;border-radius:8px;font-size:12px;padding:6px 8px;opacity:1}
            #rpg-debug-log{background:#222;color:#ffe066;font-size:12px;border-radius:8px;padding:6px 8px;height:100%;overflow:auto}
              .rpg-debug-overlay .rpg-debug-collapse{position:absolute;top:6px;right:6px;border:none;background:#333;color:#ffe066;border-radius:6px;padding:2px 6px;cursor:pointer;font-family:ui-monospace,Menlo,monospace;font-size:12px;display:none}
              .rpg-debug-overlay.open .rpg-debug-collapse{display:block}
              /* Hide any legacy banner/log inside the embedded workshop to avoid duplicates */
              #workshop-container #rpg-debug-banner, #workshop-container #rpg-debug-log { display:none !important; }
          `;
          document.head.appendChild(style);
        }
        if (!document.getElementById('rpg-debug-overlay')) {
          const overlay = document.createElement('div');
          overlay.id = 'rpg-debug-overlay';
          overlay.className = 'rpg-debug-overlay collapsed';
          const t = (window.i18n && window.i18n.t) ? window.i18n.t : (k,f)=>f||k;
          overlay.innerHTML = `
            <button class="rpg-debug-toggle" type="button" data-i18n="rpg.debug.toggle">${t('rpg.debug.toggle','./debug')}</button>
            <div class="rpg-debug-panel">
                <button class="rpg-debug-collapse" type="button" title="${t('rpg.debug.close','Close')}" data-i18n-title="rpg.debug.close">×</button>
              <div id="rpg-debug-banner" data-i18n="rpg.debug.bannerInitial">${t('rpg.debug.bannerInitial','[DEBUG] RPG Panel Loaded - Waiting for logic.js and validate.js...')}</div>
              <div id="rpg-debug-log"></div>
            </div>`;
          document.body.appendChild(overlay);
          const toggle = overlay.querySelector('.rpg-debug-toggle');
          toggle.addEventListener('click',()=>{
            overlay.classList.toggle('open');
            overlay.classList.toggle('collapsed');
          });
            const collapse = overlay.querySelector('.rpg-debug-collapse');
            collapse.addEventListener('click', (e) => {
              e.stopPropagation();
              overlay.classList.remove('open');
              overlay.classList.add('collapsed');
            });
        }
      }

      ensureRPGDebugOverlay();
      try {
        const res = await fetch('/ws/workshop?lesson_id=rpg');
        const data = await res.json();
        if (data.indexHtml) {
          container.innerHTML = data.indexHtml;
          // Remove any duplicate banner/log injected by workshop HTML to avoid multiple elements
          const dupeBanner = container.querySelector('#rpg-debug-banner');
          if (dupeBanner && dupeBanner.parentElement) dupeBanner.parentElement.removeChild(dupeBanner);
          const dupeLog = container.querySelector('#rpg-debug-log');
          if (dupeLog && dupeLog.parentElement) dupeLog.parentElement.removeChild(dupeLog);
          if (data.hasStyle && !document.querySelector('link[href*="lesson_id=rpg&file=style.css"]')) {
            const style = document.createElement('link');
            style.rel = 'stylesheet';
            style.href = `/ws/workshop_asset?lesson_id=rpg&file=style.css`;
            document.head.appendChild(style);
          }
          // Only inject logic.js if not already present
          if (data.hasLogic && !document.querySelector('script[src*="lesson_id=rpg&file=logic.js"]')) {
            const script = document.createElement('script');
            script.src = `/ws/workshop_asset?lesson_id=rpg&file=logic.js`;
            script.onload = () => {
              // After logic.js loads, send set-activity to terminal
              sendSetActivity();
                // Patch global appendRPGDebugLog to route into overlay
                try {
                  window.appendRPGDebugLog = function(msg){
                    const logEl = document.getElementById('rpg-debug-log');
                    if (logEl) {
                      logEl.innerHTML += `<div>${new Date().toLocaleTimeString()} - ${msg}</div>`;
                      logEl.scrollTop = logEl.scrollHeight;
                    }
                    console.log('[RPG-DEBUG]', msg);
                  };
                } catch(_e) {}
            };
            document.body.appendChild(script);
          } else {
            // If already present, send set-activity immediately
            sendSetActivity();
          }
          function sendSetActivity() {
            if (window.socket && window.socket.readyState === WebSocket.OPEN) {
              window.socket.send(JSON.stringify({ type: 'set-activity', activity: 'rpg' }));
            }
          }
        } else {
          const msg = (window.i18n && window.i18n.t) ? window.i18n.t('workshop.loadFailed') : 'Failed to load RPG workshop.';
          container.innerHTML = `<div>${msg}</div>`;
        }
      } catch (e) {
        const msg = (window.i18n && window.i18n.t) ? window.i18n.t('workshop.loadError') : 'Workshop load error.';
        container.innerHTML = `<div>${msg}</div>`;
      }
    });

    // Terminal settings apply logic
    document.addEventListener('DOMContentLoaded', function() {
      const applyBtn = document.getElementById('apply-terminal-style-btn');
      if (applyBtn) {
        applyBtn.addEventListener('click', function() {
          const bg = document.getElementById('terminal-bg-color').value;
          const fg = document.getElementById('terminal-text-color').value;
          const font = document.getElementById('terminal-font-style').value;
          // Save to localStorage
          localStorage.setItem('terminalBg', bg);
          localStorage.setItem('terminalFg', fg);
          localStorage.setItem('terminalFont', font);
          // Dispatch event to update terminal live
          window.dispatchEvent(new CustomEvent('apply-terminal-style', { detail: { bg, fg, font } }));
        });
      }
    });

    // --- Enable drag-and-drop reordering inside drop area ---
    document.addEventListener('DOMContentLoaded', function() {
      const dropArea = document.getElementById('drop-area');
      let draggedBlock = null;
      let dragOverBlock = null;

      // Make dropped blocks draggable and reorderable
      function makeBlockDraggable(block) {
        block.setAttribute('draggable', 'true');
        block.dataset.draggable = "true";
        block.addEventListener('dragstart', function(e) {
          draggedBlock = block;
          e.dataTransfer.setData('text/plain', 'reposition');
          e.dataTransfer.effectAllowed = 'move';
          setTimeout(() => block.classList.add('dragging'), 0);
        });
        block.addEventListener('dragend', function() {
          draggedBlock = null;
          block.classList.remove('dragging');
        });
        block.addEventListener('dragover', function(e) {
          e.preventDefault();
        });
        block.addEventListener('drop', function(e) {
          e.preventDefault();
          if (draggedBlock && draggedBlock !== block) {
            // Insert before or after depending on mouse position
            const rect = block.getBoundingClientRect();
            const offset = e.clientY - rect.top;
            if (offset < rect.height / 2) {
              dropArea.insertBefore(draggedBlock, block);
            } else {
              dropArea.insertBefore(draggedBlock, block.nextSibling);
            }
          }
        });
      }

      // On page load, make any existing blocks draggable
      Array.from(dropArea.children).forEach(makeBlockDraggable);

      // When a new block is added (by blocks.js), make it draggable
      const observer = new MutationObserver(() => {
        Array.from(dropArea.children).forEach(makeBlockDraggable);
      });
      observer.observe(dropArea, { childList: true });
    });

    // Terminal dropdown logic
    document.addEventListener('DOMContentLoaded', function() {
      const dropdownBtn = document.getElementById('btn-terminal-dropdown');
      const dropdownMenu = document.getElementById('terminal-dropdown-menu');
      let dropdownOpen = false;

      if (dropdownBtn && dropdownMenu) {
        dropdownBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          // Position the dropdown relative to the button
          const btnRect = dropdownBtn.getBoundingClientRect();
          const consoleRect = dropdownBtn.closest('.console').getBoundingClientRect();
          dropdownMenu.style.left = (btnRect.left - consoleRect.left) + 'px';
          dropdownMenu.style.top = (btnRect.bottom - consoleRect.top) + 'px';
          dropdownMenu.style.display = dropdownOpen ? 'none' : 'block';
          dropdownOpen = !dropdownOpen;
        });

        // Hide dropdown when clicking outside
        document.addEventListener('click', function() {
          dropdownMenu.style.display = 'none';
          dropdownOpen = false;
        });

        dropdownMenu.addEventListener('click', function(e) {
          e.stopPropagation();
          const action = e.target.getAttribute('data-action');
          if (!action) return;
          // Implement your terminal action logic here
          switch (action) {
            case 'delete':
              // delete current terminal logic
              break;
            case 'end-process':
              // end running process logic
              break;
            case 'shell-root':
              // switch to root shell logic
              break;
            case 'shell-bash':
              // switch to bash logic
              break;
            case 'shell-zsh':
              // switch to zsh logic
              break;
            case 'shell-batch':
              // switch to batch logic
              break;
            case 'shell-pwsh':
              // switch to PowerShell logic
              break;
          }
          dropdownMenu.style.display = 'none';
          dropdownOpen = false;
        });
      }
    });
    // --- Achievements dropdown and popup logic ---
    document.addEventListener('DOMContentLoaded', function() {
      const trophyBtn = document.getElementById('trophy-btn');
      const dropdown = document.getElementById('achievements-dropdown');
      const listDiv = document.getElementById('achievements-list');
      const popup = document.getElementById('achievement-popup');
      const popupBody = document.getElementById('achievement-popup-body');
      const popupClose = document.getElementById('achievement-popup-close');
      let achievements = [];
      let userAchievements = [];

      function fetchAchievements() {
        return fetch('/achievements.json').then(r => r.json());
      }
      function fetchUserAchievements() {
        // Use window.userId or username
        const userId = window.userId || document.querySelector('.client-id')?.textContent;
        return fetch(`/user/progress?userId=${encodeURIComponent(userId)}`)
          .then(r => r.json())
          .then((data) => data.achievements || []);
      }
      async function renderAchievements() {
        achievements = await fetchAchievements();
        userAchievements = await fetchUserAchievements();
        listDiv.innerHTML = '';
        if(!achievements.length){
          const emptyMsg = (window.i18n && window.i18n.t) ? window.i18n.t('achievements.empty','No achievements yet.') : 'No achievements yet.';
          listDiv.innerHTML = `<div style="padding:12px;color:#888;font-size:0.9em;">${emptyMsg}</div>`;
          return;
        }
        achievements.forEach(a => {
          const achieved = userAchievements.includes(a.name);
          const item = document.createElement('div');
          item.className = 'achievement-item';
          item.style.display = 'flex';
          item.style.alignItems = 'center';
          item.style.gap = '12px';
          item.style.margin = '8px 0';
          item.style.opacity = achieved ? '1' : '0.4';
          item.style.cursor = 'pointer';
          item.onclick = () => showAchievementPopup(a, achieved);
          // SVG icon
          const icon = document.createElement('img');
          icon.src = `/assets/achievements/${a.svg}`;
          icon.alt = a.name;
          icon.style.width = '36px';
          icon.style.height = '36px';
          icon.style.filter = achieved ? '' : 'grayscale(1)';
          item.appendChild(icon);
          // Name and desc
          const textDiv = document.createElement('div');
          textDiv.innerHTML = `<b>${a.name}</b><br><span style="font-size:0.95em;">${a.description}</span>`;
          item.appendChild(textDiv);
          listDiv.appendChild(item);
        });
      }
      function showAchievementPopup(a, achieved) {
        const stepLabel = (window.i18n && window.i18n.t) ? window.i18n.t('achievements.stepTask') : 'Step/Task:';
        const unlocked = (window.i18n && window.i18n.t) ? window.i18n.t('achievements.unlocked') : 'Unlocked!';
        const locked = (window.i18n && window.i18n.t) ? window.i18n.t('achievements.locked') : 'Locked';
        popupBody.innerHTML = `
          <img src="/assets/achievements/${a.svg}" alt="${a.name}" style="width:64px;height:64px;${achieved ? '' : 'filter:grayscale(1);'}"><br>
          <div style="font-size:1.3em;font-weight:bold;margin:12px 0;">${a.name}</div>
          <div style="margin-bottom:12px;">${a.description}</div>
          <div style="color:#888;font-size:0.95em;">${stepLabel} ${a.step}</div>
          ${achieved ? `<div style="color:#63b22b;font-weight:bold;margin-top:12px;">${unlocked}</div>` : `<div style=\"color:#888;margin-top:12px;\">${locked}</div>`}
        `;
        popup.style.display = 'flex';
      }
      trophyBtn.onclick = function(e) {
        e.stopPropagation();
        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        renderAchievements();
      };
      document.addEventListener('click', function(e) {
        if (!dropdown.contains(e.target) && e.target !== trophyBtn) {
          dropdown.style.display = 'none';
        }
        if (popup.style.display === 'flex' && !popup.contains(e.target)) {
          popup.style.display = 'none';
        }
      });
      popupClose.onclick = () => popup.style.display = 'none';
    });
  </script>

  <!-- Achievements Dropdown Panel -->
  <div id="achievements-dropdown" style="display:none; position:absolute; right:32px; top:64px; z-index:1000;">
    <div id="achievements-list" style="max-height:340px; overflow-y:auto; min-width:320px;"></div>
  </div>
  <!-- Achievement Popup Modal -->
  <div id="achievement-popup" class="achievement-popup" style="display:none; flex-direction:column; align-items:center;">
    <button id="achievement-popup-close" style="align-self:flex-end; background:none; border:none; color:#fff; font-size:1.5em; cursor:pointer;">&times;</button>
    <div id="achievement-popup-body"></div>
  </div>

  <script>
  // Global error handler for missing images/icons
  window.addEventListener('error', function(e) {
    if (e.target && e.target.tagName === 'IMG') {
      console.warn('Missing image asset:', e.target.src);
      e.target.style.opacity = 0.3;
      e.target.alt = 'Missing asset';
    }
  }, true);
  </script>

  <div id="sidebar-content"></div>
  <div id="workshop-content"></div>
  <button id="load-workshop" style="display:none"></button>
  <button id="select-workshop" style="display:none"></button>
  <button id="restart-workshop" style="display:none"></button>
  <input id="workshop-file-input" type="file" style="display:none" />
</body>
<script>
// Playwright terminal-ws.spec expects WebSocket frame objects with text() accessor.
// We can't modify Playwright internals, but we can ensure messages include string payloads.
// This shim wraps WebSocket send to keep behavior while not breaking app logic.
(function(){
  try {
    const NativeWS = window.WebSocket;
    if(!NativeWS.__BB_PATCHED__) {
      function Patched(url, proto){ const ws = new NativeWS(url, proto); return ws; }
      Patched.prototype = NativeWS.prototype;
      NativeWS.__BB_PATCHED__ = true;
      window.WebSocket = Patched;
    }
  } catch(e) { /* ignore */ }
})();
</script>
<script>
(function(){
  try {
    var span = document.querySelector('span.client-id');
    if(span && /\{\{username\}\}/.test(span.textContent||'')){
      var m = document.cookie.match(/(?:^|; )username=([^;]+)/);
      if(m){ try { span.textContent = decodeURIComponent(m[1]); } catch { span.textContent = m[1]; } }
    }
  } catch(e) {}
})();
</script>
</html>